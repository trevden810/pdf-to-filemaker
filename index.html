<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PepMove PDF to FileMaker - Extract PDF Data</title>
    <meta name="description" content="Extract data from PDF documents and export to FileMaker Pro">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: #666;
            font-size: 16px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .upload-section {
            text-align: center;
        }

        .drop-zone {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 60px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #f8f9ff, #e8f0fe);
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(transparent, rgba(102, 126, 234, 0.1), transparent);
            animation: rotate 4s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drop-zone:hover::before {
            opacity: 1;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .drop-zone:hover {
            border-color: #5a6ff5;
            background: linear-gradient(145deg, #e8f0fe, #f0f7ff);
            transform: translateY(-2px);
        }

        .drop-zone.drag-over {
            border-color: #34a853;
            background: linear-gradient(145deg, #e6f4ea, #f0fff0);
            box-shadow: 0 0 30px rgba(52, 168, 83, 0.3);
        }

        .drop-zone h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 24px;
            position: relative;
            z-index: 1;
        }

        .drop-zone p {
            color: #666;
            font-size: 16px;
            position: relative;
            z-index: 1;
        }

        #fileInput {
            display: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .required::after {
            content: ' *';
            color: #e74c3c;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        .btn-submit {
            background: linear-gradient(135deg, #34a853, #2d9144);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 168, 83, 0.3);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 168, 83, 0.4);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-clear {
            background: linear-gradient(135deg, #6c757d, #545b62);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-debug {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-debug:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .message {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
            position: relative;
        }

        .message.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message.info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid rgba(102, 126, 234, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-info,
        .extraction-status {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #e8f0fe, #f0f7ff);
            border: 1px solid #d2e3fc;
            border-radius: 8px;
            display: none;
        }

        .extraction-status {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .extracted-field {
            color: #28a745;
            font-weight: 600;
        }

        .not-extracted {
            color: #dc3545;
        }

        .debug-section {
            margin-top: 20px;
            display: none;
        }

        .debug-text {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #e1e5e9;
            font-size: 14px;
            color: #666;
        }

        .github-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .github-link:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 28px;
            }
            
            .drop-zone {
                padding: 40px 20px;
            }
        }
    </style>
</head>
<body>
    <a href="https://github.com/trevden810/pdf-to-filemaker" class="github-link" target="_blank" title="View on GitHub">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="#333">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
    </a>

    <div class="container">
        <header>
            <h1>📄 PepMove PDF Extractor</h1>
            <p>Extract data from PDF documents and export to FileMaker Pro</p>
        </header>

        <div id="message" class="message"></div>

        <div class="card upload-section">
            <div class="drop-zone" id="dropZone">
                <h3>📁 Upload Your PDF</h3>
                <p>Drag and drop your PDF here or click to browse</p>
                <input type="file" id="fileInput" accept=".pdf">
            </div>
            <div id="fileInfo" class="file-info"></div>
            <div id="extractionStatus" class="extraction-status"></div>
        </div>

        <div class="card">
            <div class="stats">
                <span>🎯 <strong>Smart Extraction Enabled</strong></span>
                <span>Powered by PDF.js</span>
            </div>
            
            <form id="dataForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="jobId" class="required">Job ID</label>
                        <input type="text" id="jobId" name="job_id" required placeholder="Enter job identifier">
                    </div>

                    <div class="form-group">
                        <label for="client" class="required">Client</label>
                        <input type="text" id="client" name="client_code_id_kf" required placeholder="Client name or code">
                    </div>

                    <div class="form-group">
                        <label for="jobDate">Job Date</label>
                        <input type="date" id="jobDate" name="job_date">
                    </div>

                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="job_status">
                            <option value="">Select Status</option>
                            <option value="Complete">Complete</option>
                            <option value="Attempted">Attempted</option>
                            <option value="Canceled">Canceled</option>
                            <option value="Rescheduled">Rescheduled</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="driver">Driver</label>
                        <input type="text" id="driver" name="lead_id_kf" placeholder="Driver name">
                    </div>

                    <div class="form-group">
                        <label for="pickup">Pickup Location</label>
                        <input type="text" id="pickup" name="location_load" placeholder="Pickup address">
                    </div>

                    <div class="form-group">
                        <label for="delivery">Delivery Location</label>
                        <input type="text" id="delivery" name="location_return" placeholder="Delivery address">
                    </div>

                    <div class="form-group full-width">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes_driver" rows="3" placeholder="Additional notes or comments"></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-submit">💾 Export to FileMaker</button>
                    <button type="button" class="btn-clear" onclick="clearForm()">🔄 Clear Form</button>
                    <button type="button" class="btn-debug" onclick="toggleDebug()">🔍 Debug PDF</button>
                </div>
            </form>
        </div>

        <div class="card debug-section" id="debugSection">
            <h3>🔧 PDF Text Debug</h3>
            <p>Raw text extracted from PDF (first 2000 characters):</p>
            <div id="debugText" class="debug-text">No PDF loaded. Upload a PDF to see extracted text.</div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p><strong>Processing PDF...</strong></p>
            <p>Extracting text and analyzing content</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentPdfText = '';
        let processingStats = { totalFields: 7, extractedCount: 0 };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const form = document.getElementById('dataForm');
            
            // Set today's date
            document.getElementById('jobDate').value = new Date().toISOString().split('T')[0];

            // Drag and drop handlers
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    handleFile(files[0]);
                } else {
                    showMessage('Please upload a PDF file', 'error');
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // Form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                exportData();
            });
        });

        async function handleFile(file) {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showMessage('File size too large. Please upload a PDF smaller than 10MB.', 'error');
                return;
            }

            showMessage('🔄 Processing PDF...', 'info');
            document.getElementById('loading').style.display = 'block';
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>📄 ${file.name}</strong><br>
                <small>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB | Pages: Loading...</small>
            `;
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                // Update file info with page count
                fileInfo.innerHTML = `
                    <strong>📄 ${file.name}</strong><br>
                    <small>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB | Pages: ${pdf.numPages}</small>
                `;
                
                let fullText = '';
                let pageTexts = [];
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    pageTexts.push(pageText);
                    fullText += pageText + '\n';
                }
                
                currentPdfText = fullText;
                
                // Extract data
                const extractionResults = extractDataFromText(fullText);
                updateExtractionStatus(extractionResults);
                
                const successMessage = `✅ PDF processed! Extracted ${extractionResults.extractedCount}/${extractionResults.totalFields} fields automatically.`;
                showMessage(successMessage, 'success');
                
            } catch (error) {
                console.error('PDF processing error:', error);
                showMessage(`❌ Error processing PDF: ${error.message}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function extractDataFromText(text) {
            const results = {
                extractedCount: 0,
                totalFields: 7,
                fields: {}
            };

            // Clean text for better matching
            const cleanText = text.replace(/\s+/g, ' ').trim();
            console.log('🔍 Analyzing PDF text:', cleanText.substring(0, 300) + '...');

            // Job ID extraction
            const jobIdPatterns = [
                /(?:Job|Order|Reference|ID|#)\s*[:\-#]?\s*([A-Z0-9\-]{3,20})/gi,
                /\b([A-Z]{2,}\d{3,})\b/g,
                /\b(\d{4,8})\b/g
            ];
            
            for (const pattern of jobIdPatterns) {
                const matches = [...cleanText.matchAll(pattern)];
                if (matches.length > 0) {
                    const jobId = matches[0][1];
                    if (jobId && jobId.length >= 3) {
                        document.getElementById('jobId').value = jobId;
                        results.extractedCount++;
                        results.fields.jobId = jobId;
                        console.log('✅ Found Job ID:', jobId);
                        break;
                    }
                }
            }
            
            // Client extraction
            const clientPatterns = [
                /(?:Client|Customer|Company|Account|Bill\s*to)\s*[:\-]?\s*([A-Za-z0-9\s&.,'-]{3,50}?)(?:\n|$|,|\|)/gi,
                /(?:Client|Customer)\s*Name\s*[:\-]?\s*([A-Za-z0-9\s&.,'-]{3,50}?)(?:\n|$|,|\|)/gi
            ];
            
            for (const pattern of clientPatterns) {
                const match = cleanText.match(pattern);
                if (match && match[1] && match[1].trim().length > 2) {
                    const client = match[1].trim();
                    document.getElementById('client').value = client;
                    results.extractedCount++;
                    results.fields.client = client;
                    console.log('✅ Found Client:', client);
                    break;
                }
            }
            
            // Driver extraction
            const driverPatterns = [
                /(?:Driver|Operator|Technician|Tech|Assigned\s*to)\s*[:\-]?\s*([A-Za-z\s]{3,30}?)(?:\n|$|,|\|)/gi
            ];
            
            for (const pattern of driverPatterns) {
                const match = cleanText.match(pattern);
                if (match && match[1] && match[1].trim().length > 2) {
                    const driver = match[1].trim();
                    document.getElementById('driver').value = driver;
                    results.extractedCount++;
                    results.fields.driver = driver;
                    console.log('✅ Found Driver:', driver);
                    break;
                }
            }
            
            // Pickup location
            const pickupPatterns = [
                /(?:Pick\s*up|Pickup|From|Origin|Load)\s*(?:Location|Address)?\s*[:\-]?\s*([A-Za-z0-9\s,.-]{8,100}?)(?:\n|$|\|)/gi
            ];
            
            for (const pattern of pickupPatterns) {
                const match = cleanText.match(pattern);
                if (match && match[1] && match[1].trim().length > 7) {
                    const pickup = match[1].trim();
                    if (!pickup.match(/^(time|date|status|complete|driver)/i)) {
                        document.getElementById('pickup').value = pickup;
                        results.extractedCount++;
                        results.fields.pickup = pickup;
                        console.log('✅ Found Pickup:', pickup);
                        break;
                    }
                }
            }
            
            // Delivery location
            const deliveryPatterns = [
                /(?:Deliver\s*to|Delivery|To|Destination|Drop|Unload)\s*(?:Location|Address)?\s*[:\-]?\s*([A-Za-z0-9\s,.-]{8,100}?)(?:\n|$|\|)/gi
            ];
            
            for (const pattern of deliveryPatterns) {
                const match = cleanText.match(pattern);
                if (match && match[1] && match[1].trim().length > 7) {
                    const delivery = match[1].trim();
                    if (!delivery.match(/^(time|date|status|complete|driver)/i)) {
                        document.getElementById('delivery').value = delivery;
                        results.extractedCount++;
                        results.fields.delivery = delivery;
                        console.log('✅ Found Delivery:', delivery);
                        break;
                    }
                }
            }

            // Date extraction
            const datePatterns = [
                /(?:Date|Scheduled|Service|Due)\s*[:\-]?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/gi,
                /\b(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})\b/g
            ];
            
            for (const pattern of datePatterns) {
                const match = cleanText.match(pattern);
                if (match && match[1]) {
                    try {
                        const dateStr = match[1].replace(/\-/g, '/');
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime()) && date.getFullYear() > 2020) {
                            const formattedDate = date.toISOString().split('T')[0];
                            document.getElementById('jobDate').value = formattedDate;
                            results.extractedCount++;
                            results.fields.date = formattedDate;
                            console.log('✅ Found Date:', dateStr);
                            break;
                        }
                    } catch (e) {
                        console.log('Date parsing error:', e);
                    }
                }
            }

            // Notes extraction
            const notesPatterns = [
                /(?:Notes?|Comments?|Instructions?|Remarks?)\s*[:\-]?\s*([A-Za-z0-9\s,.-]{10,200}?)(?:\n\s*\n|$)/gi
            ];
            
            for (const pattern of notesPatterns) {
                const match = cleanText.match(pattern);
                if (match && match[1] && match[1].trim().length > 9) {
                    const notes = match[1].trim();
                    document.getElementById('notes').value = notes;
                    results.extractedCount++;
                    results.fields.notes = notes;
                    console.log('✅ Found Notes:', notes.substring(0, 50) + '...');
                    break;
                }
            }

            processingStats = results;
            return results;
        }

        function updateExtractionStatus(results) {